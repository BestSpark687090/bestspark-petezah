---
const url = Astro.site ? Astro.site.origin : Astro.url.origin;
const path = Astro.url.pathname;
const fullUrl = `${url}${path}`;

export interface Review {
  author: string;
  datePublished: string;
  reviewBody: string;
  reviewRating: number; // 1-5
}

export interface ForumPost {
  headline: string;
  author: string;
  datePublished: string;
  text: string;
  interactionCount?: number; // Replies
}

export interface Props {
  title?: string;
  description?: string;
  image?: string;
  publishDate?: string;
  modifiedDate?: string;
  type?: 'website' | 'game' | 'article' | 'discussion';
  author?: string;

  // Game / Product Specifics
  ratingValue?: number; // Aggregate rating (e.g. 4.5)
  ratingCount?: number; // Total votes
  genre?: string[];
  platform?: string[];
  price?: string;
  currency?: string;

  // Reviews (Individual user reviews)
  reviews?: Review[];

  // Discussion Forum Specifics
  forumThread?: ForumPost; // The main post of the thread

  // FAQ
  faq?: { question: string; answer: string }[];
}

const {
  title,
  description: propDescription,
  image,
  publishDate,
  modifiedDate,
  type = 'website',
  author = 'PeteZah Games',
  ratingValue,
  ratingCount,
  genre = ['Casual Game'],
  platform = ['Web Browser'],
  price = '0',
  currency = 'USD',
  reviews = [],
  forumThread,
  faq = []
} = Astro.props;

// --- Logic ---
const isGames = path.startsWith('/games') || type === 'game';
const isArticle = type === 'article';
const isDiscussion = type === 'discussion';
const foundingDate = new Date('February 5, 2025 18:00:00 GMT+00:00');

const computedName = title || 'PeteZah Games';
const computedFoundingDate = foundingDate.toISOString();
const computedDescription = propDescription || 'Play free online games and use web apps on PeteZah Games.';
const computedImage = image ? (image.startsWith('http') ? image : `${url}${image}`) : `${url}/assets/images/Social-preview-index.png`;

// --- Schemas ---

// Organization
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  'name': 'PeteZah Games',
  'alternateName': 'PeteZah',
  'description': 'Unblocked Games website for academic enviornmnets and free online games.',
  'url': url,
  'logo': {
    '@type': 'ImageObject',
    'url': `${url}/favicons/favicon-512x512.png`,
    'width': 512,
    'height': 512
  },
  'sameAs': [
    'https://x.com/PeteZahGames',
    'https://github.com/PeteZah-Games',
    'https://discord.gg/petezah-games-1337108365591187640',
    'https://discord.com/invite/petezah-games-1337108365591187640',
    'https://www.youtube.com/@PeteZahGames',
    'https://www.tiktok.com/@petezahpersonal'
  ],
  'contactPoint': [
    {
      '@type': 'ContactPoint',
      'email': 'contact@petezahgames.com',
      'contactType': 'customer support',
      'availableLanguage': ['en']
    },
    {
      '@type': 'ContactPoint',
      'contactType': 'legal',
      'email': 'legal@petezahgames.com',
      'availableLanguage': ['en']
    }
  ],
  'address': {
    '@type': 'PostalAddress',
    'addressCountry': 'US'
  }
};

// 2. WebSite
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  'name': 'PeteZah Games',
  'url': url,
  'potentialAction': {
    '@type': 'SearchAction',
    'target': {
      '@type': 'EntryPoint',
      'urlTemplate': `${url}/search?q={search_term_string}`
    },
    'query-input': 'required name=search_term_string'
  }
};

// 3. Breadcrumbs
const segments = path.split('/').filter(Boolean);
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  'itemListElement': [
    { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': `${url}/` },
    ...segments.map((segment, index) => ({
      '@type': 'ListItem',
      'position': index + 2,
      'name': segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, ' '),
      'item': `${url}/${segments.slice(0, index + 1).join('/')}`
    }))
  ]
};

// 4. SoftwareApplication / VideoGame
let gameSchema = null;
if (isGames) {
  gameSchema = {
    '@context': 'https://schema.org',
    '@type': ['VideoGame', 'SoftwareApplication'],
    'name': computedName,
    'description': computedDescription,
    'url': fullUrl,
    'image': computedImage,
    'genre': genre,
    'gamePlatform': platform,
    'applicationCategory': 'Game',
    'operatingSystem': 'Web Browser',
    'author': {
      '@type': 'Organization',
      'name': 'PeteZah Games'
    },
    'offers': {
      '@type': 'Offer',
      'price': price,
      'priceCurrency': currency,
      'availability': 'https://schema.org/InStock'
    }
  };

  // Aggregate Rating
  if (ratingValue) {
    gameSchema.aggregateRating = {
      '@type': 'AggregateRating',
      'ratingValue': ratingValue,
      'ratingCount': ratingCount || 1,
      'bestRating': '5',
      'worstRating': '1'
    };
  }

  // Individual Reviews
  if (reviews.length > 0) {
    gameSchema.review = reviews.map((r) => ({
      '@type': 'Review',
      'author': { '@type': 'Person', 'name': r.author },
      'datePublished': r.datePublished,
      'reviewBody': r.reviewBody,
      'reviewRating': {
        '@type': 'Rating',
        'ratingValue': r.reviewRating,
        'bestRating': '5',
        'worstRating': '1'
      }
    }));
  }
}

// DiscussionForumPosting
let forumSchema = null;
if (isDiscussion && forumThread) {
  forumSchema = {
    '@context': 'https://schema.org',
    '@type': 'DiscussionForumPosting',
    'headline': forumThread.headline,
    'text': forumThread.text,
    'author': {
      '@type': 'Person',
      'name': forumThread.author
    },
    'datePublished': forumThread.datePublished,
    'interactionStatistic': {
      '@type': 'InteractionCounter',
      'interactionType': 'https://schema.org/CommentAction',
      'userInteractionCount': forumThread.interactionCount || 0
    },
    'publisher': organizationSchema
  };
}

// Article
let articleSchema = null;
if (isArticle) {
  articleSchema = {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    'mainEntityOfPage': { '@type': 'WebPage', '@id': fullUrl },
    'headline': computedName,
    'description': computedDescription,
    'image': computedImage,
    'author': { '@type': 'Person', 'name': author },
    'publisher': organizationSchema,
    'datePublished': publishDate,
    'dateModified': modifiedDate || publishDate
  };
}

// FAQPage
let faqSchema = null;
if (faq.length > 0) {
  faqSchema = {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    'mainEntity': faq.map((item) => ({
      '@type': 'Question',
      'name': item.question,
      'acceptedAnswer': { '@type': 'Answer', 'text': item.answer }
    }))
  };
}

// WebPage
const webpageSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebPage',
  'name': computedName,
  'url': fullUrl,
  'description': computedDescription
};
---

<!-- Core Global Schemas -->
<script type="application/ld+json" is:inline set:html={JSON.stringify(organizationSchema)} />
<script type="application/ld+json" is:inline set:html={JSON.stringify(websiteSchema)} />
<script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbSchema)} />

<!-- Contextual Schemas -->{gameSchema && <script type="application/ld+json" set:html={JSON.stringify(gameSchema)} />}
{forumSchema && <script type="application/ld+json" set:html={JSON.stringify(forumSchema)} />}
{articleSchema && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}
{faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}

<!-- Fallback -->
{!gameSchema && !forumSchema && !articleSchema && <script type="application/ld+json" set:html={JSON.stringify(webpageSchema)} />}
