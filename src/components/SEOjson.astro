---
import type { Organization, WithContext, WebSite, BreadcrumbList, Game, Article, DiscussionForumPosting, FAQPage, WebPage, HowTo } from 'schema-dts';

/**
 * User review for Schema.org structured data
 */
export interface Review {
  /** Author of the review */
  author: string;
  /** Publication date (ISO format) */
  datePublished: string;
  /** Review text content */
  reviewBody: string;
  /** Rating value from 1-5 */
  reviewRating: number;
}

/**
 * Frequently asked question item
 */
export interface FaqItem {
  /** Question text */
  question: string;
  /** Answer text */
  answer: string;
}

/**
 * Step in a "How To" guide
 */
export interface HowToStep {
  /** Step name/title */
  name: string;
  /** Step description/instructions */
  text: string;
}

/**
 * Forum post/thread information for Schema.org DiscussionForumPosting
 */
export interface ForumPost {
  /** Post title/headline */
  headline: string;
  /** Post author name */
  author: string;
  /** Publication date (ISO format) */
  datePublished: string;
  /** Post text content */
  text: string;
  /** Optional interaction count (comments, replies) */
  interactionCount?: number;
}

/**
 * Props interface for SEOjson component
 * Supports website, game, article, discussion, profile, howto, and collection content types
 */
export interface Props {
  // Global metadata
  /** Page title */
  title?: string;
  /** Page description for meta tags and schema.org */
  description?: string;
  /** Image URL for Open Graph and Schema.org */
  image?: string;
  /** Publication date (ISO format) */
  publishDate?: string;
  /** Last modification date (ISO format) */
  modifiedDate?: string;
  /** Author name */
  author?: string;
  /** Content type: website | game | article | discussion | profile | howto | collection */
  type?: 'website' | 'game' | 'article' | 'discussion' | 'profile' | 'howto' | 'collection';

  // Organization Details
  /** Organization information including founding date, founders, and knowledge areas */
  org?: {
    /** Founding date (ISO Date e.g. "2025-02-05") */
    foundingDate?: string;
    /** Founders' names */
    founders?: string[];
    /** Organization slogan */
    slogan?: string;
    /** Areas of expertise (e.g., ["Game Development", "Web Apps"]) */
    knowsAbout?: string[];
  };

  // Article Specifics
  /** Article type for Schema.org: BlogPosting | NewsArticle | Article | TechArticle */
  articleType?: 'BlogPosting' | 'NewsArticle' | 'Article' | 'TechArticle';
  /** Word count for articles */
  wordCount?: number;

  // Game / Product Specifics
  /** Aggregate rating value (e.g., 4.5) */
  ratingValue?: number;
  /** Total number of rating votes */
  ratingCount?: number;
  /** Game genres (e.g., ["Action", "Puzzle"]) */
  genre?: string[];
  /** Supported platforms (e.g., ["Web Browser"]) */
  platform?: string[];
  /** Price as string */
  price?: string;
  /** Currency code (e.g., "USD") */
  currency?: string;
  /** Array of user reviews */
  reviews?: Review[];
  /** Play modes: SinglePlayer, MultiPlayer, or both */
  playMode?: ('SinglePlayer' | 'MultiPlayer')[];

  // Discussion
  /** Main post of a forum thread */
  forumThread?: ForumPost;

  // FAQ
  /** Frequently asked questions */
  faq?: FaqItem[];

  // HowTo
  /** Steps for a "How To" guide */
  steps?: HowToStep[];
}

const {
  title,
  description: propDescription,
  image,
  publishDate,
  modifiedDate,
  type = 'website',
  author = 'PeteZah Games',
  org = {},
  articleType = 'BlogPosting',
  wordCount,

  // Game
  ratingValue,
  ratingCount,
  genre = ['Casual Game'],
  platform = ['Web Browser'],
  price = '0',
  currency = 'USD',
  reviews = [],
  playMode,

  // Discussion
  forumThread,

  // FAQ
  faq = [],

  // HowTo
  steps = []
}: Props = Astro.props;

// --- Logic ---
/** Full URL of the current page */
const url: string = Astro.site ? Astro.site.origin : Astro.url.origin;
/** Current page pathname */
const path: string = Astro.url.pathname;
/** Complete page URL */
const fullUrl: string = `${url}${path}`;

/** Determine if current page is a game page */
const isGame: boolean = path.startsWith('/games') || type === 'game';
/** Determine if current page is an article */
const isArticle: boolean = type === 'article';
/** Determine if current page is a discussion/forum post */
const isDiscussion: boolean = type === 'discussion';
/** Determine if current page is a "How To" guide */
const isHowTo: boolean = type === 'howto';

/** Computed page title for Schema.org */
const computedName: string = title || 'PeteZah Games';
/** Computed page description */
const computedDescription: string = propDescription || 'Play free online games and use web apps on PeteZah Games.';
/** Computed image URL, ensuring absolute URL */
const computedImage: string = image ? (image.startsWith('http') ? image : `${url}${image}`) : `${url}/assets/images/Social-preview-index.png`;

// --- 1. Organization Schema ---
const organizationSchema: WithContext<Organization> = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  'name': 'PeteZah Games',
  'alternateName': 'PeteZah',
  'url': url,
  'logo': {
    '@type': 'ImageObject',
    'url': `${url}/favicons/favicon-512x512.png`,
    'width': '512',
    'height': '512'
  },
  'slogan': org.slogan || 'Play Free. Play Unblocked.',
  'foundingDate': org.foundingDate || '2025-02-05T18:00:00+00:00', // Default or Custom
  'knowsAbout': org.knowsAbout || ['Browser Games', 'Web Development'],
  'sameAs': [
    'https://x.com/PeteZahGames',
    'https://github.com/PeteZah-Games',
    'https://discord.gg/petezah-games',
    'https://www.youtube.com/@PeteZahGames'
  ],
  'contactPoint': [
    {
      '@type': 'ContactPoint',
      'email': 'contact@petezahgames.com',
      'contactType': 'customer support',
      'availableLanguage': ['en']
    }
  ]
};

// Add Founders dynamically
if (org.founders && org.founders.length > 0) {
  organizationSchema['founder'] = org.founders.map((name) => ({
    '@type': 'Person',
    'name': name
  }));
}

// --- 2. WebSite Schema ---
const websiteSchema: WithContext<WebSite> = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  'name': 'PeteZah Games',
  'url': url,
  'potentialAction': {
    '@type': 'SearchAction',
    'target': {
      '@type': 'EntryPoint',
      'urlTemplate': `${url}/search?q={search_term_string}`
    }
  } as any
};

// --- 3. Breadcrumbs ---
const segments = path.split('/').filter(Boolean);
const breadcrumbSchema: WithContext<BreadcrumbList> = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  'itemListElement': [
    { '@type': 'ListItem', 'position': 1, 'name': 'Home', 'item': `${url}/` },
    ...segments.map(
      (segment, index) =>
        ({
          '@type': 'ListItem',
          'position': index + 2,
          'name': segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, ' '),
          'item': `${url}/${segments.slice(0, index + 1).join('/')}`
        }) as any
    )
  ] as any
};

// --- 4. VideoGame Schema (With Reviews) ---
let gameSchema: WithContext<Game> | null = null;
if (isGame) {
  gameSchema = {
    '@context': 'https://schema.org',
    '@type': 'VideoGame',
    'name': computedName,
    'description': computedDescription,
    'url': fullUrl,
    'image': computedImage,
    'genre': genre,
    'playMode': playMode,
    'gamePlatform': platform,
    'applicationCategory': 'Game',
    'operatingSystem': 'Web Browser',
    'author': { '@type': 'Organization', 'name': 'PeteZah Games' },
    'offers': {
      '@type': 'Offer',
      'price': price,
      'priceCurrency': currency,
      'availability': 'https://schema.org/InStock'
    }
  };

  // Aggregate Rating
  if (ratingValue) {
    gameSchema.aggregateRating = {
      '@type': 'AggregateRating',
      'ratingValue': ratingValue,
      'ratingCount': ratingCount || 1,
      'bestRating': '5',
      'worstRating': '1'
    };
  }

  // Individual Reviews
  if (reviews.length > 0) {
    gameSchema.review = reviews.map((r) => ({
      '@type': 'Review',
      'author': { '@type': 'Person', 'name': r.author },
      'datePublished': r.datePublished,
      'reviewBody': r.reviewBody,
      'reviewRating': {
        '@type': 'Rating',
        'ratingValue': r.reviewRating,
        'bestRating': '5',
        'worstRating': '1'
      }
    }));
  }
}

// --- 5. Article Schema (Dynamic Type) ---
let articleSchema: WithContext<Article> | null = null;
if (isArticle) {
  articleSchema = {
    '@context': 'https://schema.org',
    '@type': articleType, // BlogPosting, NewsArticle, etc.
    'mainEntityOfPage': { '@type': 'WebPage', '@id': fullUrl },
    'headline': computedName,
    'description': computedDescription,
    'image': computedImage,
    'author': { '@type': 'Person', 'name': author },
    'publisher': organizationSchema,
    'datePublished': publishDate,
    'dateModified': modifiedDate || publishDate,
    'wordCount': wordCount
  };
}

// --- 6. Discussion / Forum ---
let forumSchema: WithContext<DiscussionForumPosting> | null = null;
if (isDiscussion && forumThread) {
  forumSchema = {
    '@context': 'https://schema.org',
    '@type': 'DiscussionForumPosting',
    'headline': forumThread.headline,
    'text': forumThread.text,
    'author': { '@type': 'Person', 'name': forumThread.author },
    'datePublished': forumThread.datePublished,
    'interactionStatistic': {
      '@type': 'InteractionCounter',
      'interactionType': 'https://schema.org/CommentAction' as any,
      'userInteractionCount': forumThread.interactionCount || 0
    } as any,
    'publisher': organizationSchema
  };
}

// --- 7. FAQ Page Schema ---
let faqSchema: WithContext<FAQPage> | null = null;
if (faq.length > 0) {
  faqSchema = {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    'mainEntity': faq.map((item) => ({
      '@type': 'Question',
      'name': item.question,
      'acceptedAnswer': {
        '@type': 'Answer',
        'text': item.answer
      }
    }))
  };
}

// --- 8. HowTo Schema ---
let howToSchema: WithContext<HowTo> | null = null;
if (isHowTo && steps.length > 0) {
  howToSchema = {
    '@context': 'https://schema.org',
    '@type': 'HowTo',
    'name': computedName,
    'description': computedDescription,
    'step': steps.map((step, index) => ({
      '@type': 'HowToStep',
      'position': index + 1,
      'name': step.name,
      'text': step.text
    }))
  };
}

// --- Fallback ---
const webpageSchema: WithContext<WebPage> = {
  '@context': 'https://schema.org',
  '@type': 'WebPage',
  'name': computedName,
  'url': fullUrl,
  'description': computedDescription
};

const hasSpecificSchema = gameSchema || articleSchema || forumSchema || faqSchema || howToSchema;
---

<!-- Global -->
<script type="application/ld+json" is:inline set:html={JSON.stringify(organizationSchema)} />
<script type="application/ld+json" is:inline set:html={JSON.stringify(websiteSchema)} />
<script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbSchema)} />

<!-- Specific -->{gameSchema && <script type="application/ld+json" is:inline set:html={JSON.stringify(gameSchema)} />}
{articleSchema && <script type="application/ld+json" is:inline set:html={JSON.stringify(articleSchema)} />}
{forumSchema && <script type="application/ld+json" is:inline set:html={JSON.stringify(forumSchema)} />}
{faqSchema && <script type="application/ld+json" is:inline set:html={JSON.stringify(faqSchema)} />}
{howToSchema && <script type="application/ld+json" is:inline set:html={JSON.stringify(howToSchema)} />}

<!-- Fallback -->
{!hasSpecificSchema && <script type="application/ld+json" is:inline set:html={JSON.stringify(webpageSchema)} />}
