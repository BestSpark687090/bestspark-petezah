---
import fs from 'node:fs/promises';
import path from 'node:path';
import {
  generateFaviconFiles,
  generateFaviconHtml,
  IconTransformationType,
  type FaviconSettings,
  type MasterIcon
} from '@realfavicongenerator/generate-favicon';
import { getNodeImageAdapter, loadAndConvertToSvg } from '@realfavicongenerator/image-adapter-node';

/**
 * Props for the Favicon component
 */
interface Props {
  /** Path to master icon file (e.g., './src/assets/logo.svg') */
  masterIconPath: string;
}

const { masterIconPath }: Props = Astro.props;

// --- Configuration ---
/** Check if running on Vercel platform */
const isVercel: boolean = !!process.env.VERCEL;
/** Public directory path */
const PUBLIC_DIR: string = path.join(process.cwd(), 'public');
/** Favicon output directory */
const FAVICON_DIR: string = 'favicons'; // Results in public/favicons
/** Destination path for favicon files */
const DESTINATION: string = path.join(PUBLIC_DIR, FAVICON_DIR);

// --- Favicon Settings ---
/** Favicon generation configuration */
const faviconSettings: FaviconSettings = {
  icon: {
    desktop: {
      regularIconTransformation: {
        type: IconTransformationType.None,
        brightness: 0,
        backgroundColor: '#ffffff',
        backgroundRadius: 0,
        imageScale: 1
      },
      darkIconTransformation: {
        type: IconTransformationType.None,
        brightness: 0,
        backgroundColor: '#ffffff',
        backgroundRadius: 0,
        imageScale: 1
      },
      darkIconType: 'none'
    },
    touch: {
      transformation: {
        type: IconTransformationType.Background,
        backgroundColor: '#ffffff',
        backgroundRadius: 0,
        imageScale: 0.7,
        brightness: 0
      },
      appTitle: 'PeteZah-G'
    },
    webAppManifest: {
      transformation: {
        type: IconTransformationType.Background,
        backgroundColor: '#FFFFFF',
        backgroundRadius: 0,
        imageScale: 0.7,
        brightness: 0
      },
      backgroundColor: '#ffffff',
      themeColor: '#ffffff',
      name: 'PeteZah Games',
      shortName: 'PeteZah'
    }
  },
  path: `/${FAVICON_DIR}/`
};

// 2. Generation Logic (Only runs if manifest is missing and not in a read-only env)
const manifestPath = path.join(DESTINATION, 'site.webmanifest');
let filesExist = false;

try {
  await fs.access(manifestPath);
  filesExist = true;
} catch (e) {
  filesExist = false;
}

if (!filesExist && !isVercel) {
  console.log('Generating Favicons...');

  try {
    await fs.mkdir(DESTINATION, { recursive: true });

    const imageAdapter = await getNodeImageAdapter();
    const masterIcon: MasterIcon = {
      icon: await loadAndConvertToSvg(path.resolve(masterIconPath))
    };

    const faviconFilesResult = await generateFaviconFiles(masterIcon, faviconSettings, imageAdapter);

    // faviconFilesResult is an object with file names as keys and content as values
    for (const [fileName, content] of Object.entries(faviconFilesResult)) {
      if (typeof content !== 'string' && !(content instanceof Blob)) {
        await fs.writeFile(path.join(DESTINATION, fileName), content as Buffer);
      }
    }
    console.log('Favicons generated in:', DESTINATION);
  } catch (error) {
    console.error('Error generating favicons:', error);
  }
}

// 3. Generate HTML Tags
// The library returns a single string containing all tags
const result = generateFaviconHtml(faviconSettings);
const htmlString = result.markups.join('\n');
---

<Fragment set:html={htmlString} />
