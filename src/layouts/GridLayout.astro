---
import { Picture } from 'astro:assets';
import collectionData from '../data/games.json';
import AppLayout from '../layouts/AppLayout.astro';
import '../styles/grid.css';

interface Props {
  title?: string;
  description?: string;
  collection?: 'games' | 'apps';
  hasCategories?: boolean;
}

const { title = 'Collection', description = 'Browse our collection', collection = 'games'} = Astro.props;
let { hasCategories } = Astro.props;

const items = collectionData[collection] || [];

const uniqueCategories = new Set<string>();
items.forEach((item) => {
  if (Array.isArray(item.categories)) {
    item.categories.forEach((cat: string) => uniqueCategories.add(cat.toLowerCase()));
  }
});

const sortedCategories = Array.from(uniqueCategories).sort();
hasCategories ??= sortedCategories.length > 0;

const imageImports = import.meta.glob<{ default: ImageMetadata }>('../assets/images/**/*.{png,jpg,jpeg,webp,avif}', { eager: true });

const imageMap = new Map<string, ImageMetadata>();
for (const [path, module] of Object.entries(imageImports)) {
  const fileName = path.split('/').pop();
  if (fileName) {
    imageMap.set(fileName, module.default);
  }
}
---

<AppLayout title={title} description={description}>
  <!-- Background Effects -->
  <div class="bg-effects"></div>
  <Fragment slot="header">
    <!-- Random Button -->
    <button class="random-btn" id="randomItemBtn">
      Random {collection.slice(0, -1).replace(/^\w/, (c) => c.toUpperCase())}
    </button>

    <search>
      <input
        list="datalist-items"
        type="text"
        id="search-input"
        placeholder={`Search for YOUR Favorite ${collection.slice(0, -1)}â€¦`}
        autocomplete="on"
        aria-label="On this page"
      />
    </search>

    <datalist id="datalist-items">
      {items.map((item) => <option value={item.label} />)}
    </datalist>

    <div class="filter-container">
      {
        hasCategories && (
          <select id="categoryFilter">
            <option value="">Filter by Category</option>
            {sortedCategories.map((cat) => (
              <option value={cat}>{cat.charAt(0).toUpperCase() + cat.slice(1)}</option>
            ))}
          </select>
        )
      }
    </div>
  </Fragment>
  <!-- Grid Container -->
  <section class="collection-container" id="imageContainer">
    {
      items.map((item) => {
        // Find local image or use URL
        const fileName = item.imageUrl ? item.imageUrl.split('/').pop() : '';
        const localImage = fileName ? imageMap.get(fileName) : undefined;
        const isHttpUrl = item.imageUrl && (item.imageUrl.startsWith('http://') || item.imageUrl.startsWith('https://'));
        const mainCategory = item.categories?.[0]?.toLowerCase() || '';

        return (
          // Card Item
          <figure class="collection-card" data-label={item.label} data-category={mainCategory} data-url={item.url}>
            <a href={`/play?url=${encodeURIComponent(item.url)}`} aria-label={`Open ${item.label}`}>
              {localImage && (
                <Picture
                  src={localImage}
                  width={200}
                  height={170}
                  alt={item.label}
                  loading="lazy"
                  fetchpriority="auto"
                  decoding="async"
                  data-auto-detect
                  formats={['avif', 'webp', 'png']}
                />
              )}

              {!localImage && isHttpUrl && (
                <Picture
                  src={item.imageUrl}
                  width={200}
                  height={170}
                  alt={item.label}
                  loading="lazy"
                  fetchpriority="auto"
                  decoding="async"
                  data-auto-detect
                  formats={['avif', 'webp', 'png']}
                />
              )}

              {!localImage && !isHttpUrl && (
                <div style="width:200px; height:170px; background: #333; display:flex; align-items:center; justify-content:center;">
                  <span>No Image</span>
                </div>
              )}
            </a>

            <figcaption class="label">{item.label}</figcaption>
          </figure>
        );
      })
    }
  </section>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('search-input');
      const filterSelect = document.getElementById('categoryFilter'); // Nullable if no categories
      const randomBtn = document.getElementById('randomItemBtn');

      // Update selector to match the new neutral CSS class
      const allCards = Array.from(document.querySelectorAll('.collection-card'));

      /* -----------------------------
         AUTO-DETECT ABOVE THE FOLD
      ------------------------------ */
      const autoImages = document.querySelectorAll('img[data-auto-detect]');

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.loading = 'eager';
            img.fetchPriority = 'high';
            img.decoding = 'auto';
            observer.unobserve(img);
          }
        });
      });

      // Observe every image
      autoImages.forEach((img) => observer.observe(img));

      /* -----------------------------
         FILTER LOGIC
      ------------------------------ */
      function filterItems() {
        const searchTerm = searchInput.value.toLowerCase();
        // If select doesn't exist, default to empty string
        const categoryFilter = filterSelect ? filterSelect.value.toLowerCase() : '';

        allCards.forEach((card) => {
          const label = card.getAttribute('data-label').toLowerCase();
          const category = card.getAttribute('data-category');

          const matchesSearch = label.includes(searchTerm);
          // If categoryFilter is empty, we ignore category matching
          const matchesCategory = categoryFilter === '' || (category && category.includes(categoryFilter));

          card.style.display = matchesSearch && matchesCategory ? '' : 'none';
        });
      }

      /**
       * -----------------------------
       * RANDOM BUTTON
       * -----------------------------
       */
      randomBtn.addEventListener('click', () => {
        if (allCards.length > 0) {
          const randomIndex = Math.floor(Math.random() * allCards.length);
          const link = allCards[randomIndex].querySelector('a');
          if (link) window.location.href = link.href;
        }
      });

      /* -----------------------------
         DEBOUNCE & EVENTS
      ------------------------------ */
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      if (searchInput) {
        searchInput.addEventListener('input', debounce(filterItems, 300));
      }

      if (filterSelect) {
        filterSelect.addEventListener('change', filterItems);
      }
    });
  </script>
</AppLayout>
