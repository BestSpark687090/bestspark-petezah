---
// Define Packages to pass to client
export const prerender = false;
import '../../scripts/browser';
import AppLayout from '../../layouts/AppLayout.astro';
const { target } = Astro.params;
let computedURL;

/* Filter for bad domains */
// Cache
let cachedList: Set<string> | null = null;
let cachedAt = 0;

// 2 hours in milliseconds
const CACHE_DURATION = 2 * 60 * 60 * 1000;

async function getBlockedDomains() {
  const now = Date.now();

  if (cachedList && now - cachedAt < CACHE_DURATION) {
    return cachedList;
  }

  // Fetch the hosts file
  const response = await fetch('https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/gambling-porn/hosts');
  const text = await response.text();

  // Parse into a Set of domains
  const domains: Set<string> = new Set();

  for (const line of text.split('\n')) {
    const trimmed = line.trim();

    // Skip comments and empty lines
    if (!trimmed || trimmed.startsWith('#')) continue;

    const parts = trimmed.split(/\s+/);
    if (parts.length < 2) continue;

    const [ip, domain] = parts;

    // Only accept 0.0.0.0 or 127.0.0.1 entries
    if (ip === '0.0.0.0' || ip === '127.0.0.1') {
      domains.add(domain.toLowerCase());
    }
  }

  // Cache it
  cachedList = domains;
  cachedAt = now;

  return domains;
}

try {
  const decoded = decodeURIComponent(target);
  const parsed = new URL(decoded);
  if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
    throw new Error('Invalid protocol');
  }
  computedURL = parsed.toString();
} catch {
  Astro.redirect('/404');
}
---

<AppLayout title="Scramjet Embed" description=`Embedded Site for ${computedURL}`>
  <div id="status">Initializing...</div>
  <iframe id="embedFrame" style="width: 100%; height: 100%"></iframe>
  <script src="/scram/scramjet.js" is:inline></script>
  <script src="/scramcontroller/controller.api.js" is:inline type="module"></script>
</AppLayout>
