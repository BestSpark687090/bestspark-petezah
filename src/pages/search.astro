---
// Stolen Partially From: https://github.com/MercuryWorkshop/scramjet/blob/v2/packages/runway/src/harness/scramjet/public/index.html
import AppLayout from "../layouts/AppLayout.astro"
---
<AppLayout title="Search" description="Search the site">
		<h1>Scramjet Test Harness</h1>
		<div id="status">Initializing...</div>
		<button id="reload-btn" style="display: none; margin: 8px 0">
			ðŸ”„ Reload Test
		</button>
		<iframe
			id="testframe"
			style="width: 100%; height: 100%"
		></iframe>
        <script src="/scram/scramjet.js"></script>
		<script src="/scramcontroller/controller.api.js"></script>
		<script type="module">
			const statusEl = document.getElementById("status");
			const testframe = document.getElementById("testframe");
			const { Controller } = $scramjetController;
			import { LibcurlClient } from "@mercuryworkshop/libcurl-transport";

			let controller;
			let scramjetFrame;
			async function init() {
				statusEl.textContent = "Registering service worker...";
				const registration = await navigator.serviceWorker.register("/sw.js");
				// Wait for the service worker to be ready
				if (!navigator.serviceWorker.controller) {
					statusEl.textContent = "Waiting for service worker to activate...";
					await new Promise((resolve) => {
						if (registration.active) {
							resolve();
							return;
						}
						const sw = registration.installing || registration.waiting;
						if (sw) {
							sw.addEventListener("statechange", () => {
								if (sw.state === "activated") resolve();
							});
						}
					});
					// Wait for controller
					if (!navigator.serviceWorker.controller) {
						await new Promise((resolve) => {
							navigator.serviceWorker.addEventListener(
								"controllerchange",
								resolve,
								{ once: true }
							);
						});
					}
				}
				statusEl.textContent = "Initializing controller...";
				const transport = new LibcurlClient({
					wisp: "ws://localhost:4501/",
				});

				controller = new Controller({
					serviceworker: registration.active,
					transport,
				});

				await controller.ready;

				scramjetFrame = controller.createFrame(testframe);
                scramjetFrame.go("about:blank");
				setupIframeObserver();
			}

			init().catch((err) => {
				statusEl.textContent = `Error: ${err.message}`;
				console.error("Harness init error:", err);
			});
		</script>
</AppLayout >
