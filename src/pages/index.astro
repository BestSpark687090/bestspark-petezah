---
import AppLayout from '../layouts/AppLayout.astro';
import '../styles/index.css';

// --- FontAwesome Integration ---
import '@fortawesome/fontawesome-svg-core/styles.css';
import { library, icon, config } from '@fortawesome/fontawesome-svg-core';
import { faXTwitter, faDiscord } from '@fortawesome/free-brands-svg-icons';
import {
  faChevronLeft,
  faChevronRight,
  faBatteryFull,
  faBatteryThreeQuarters,
  faBatteryHalf,
  faBatteryQuarter,
  faBatteryEmpty
} from '@fortawesome/free-solid-svg-icons';

// Prevent FontAwesome from automatically adding CSS to the head
config.autoAddCss = false;

library.add(
  faXTwitter,
  faDiscord,
  faChevronLeft,
  faChevronRight,
  faBatteryFull,
  faBatteryThreeQuarters,
  faBatteryHalf,
  faBatteryQuarter,
  faBatteryEmpty
);

// Import games data
import gamesData from '../data/games.json';

// Data
const typewriterText = [
  'PeteZah Games.',
  'beauty.',
  'vibrancy.',
  'prosperity.',
  'peace.',
  'stability.',
  'amazement.',
  'resiliency.',
  'friendliness.',
  'flourishment.',
  'sustainability.'
];

// Filter highlighted games for carousel and large image
const highlightedGames = gamesData.games.filter((game) => game.isHighlighted);

// Use highlighted games for carousel, fallback to first 11 if none highlighted
const carouselGames = highlightedGames.length > 0 ? highlightedGames : gamesData.games.slice(0, 11);

// Pick a random highlighted game for the large image display
const highlightedGame = highlightedGames.length > 0 ? highlightedGames[Math.floor(Math.random() * highlightedGames.length)] : gamesData.games[0];
---

<AppLayout title="Home">
  <div class="god-rays" aria-hidden="true"></div>

  <section class="welcome-section" aria-label="Welcome">
    <h2>
      Welcome to
      <br />
      <span class="gradient-text">
        <span class="typewrite" data-period="2000" data-type={JSON.stringify(typewriterText)}>
          <span class="wrap"></span>
        </span>
      </span>
    </h2>
    <p>Game on!</p>

    <a href="/games" class="shiny-btn start-btn">
      <span>Start Gaming</span>
    </a>

    <nav class="social-media-tray" aria-label="Social Media Links">
      <a href="https://x.com/PeteZahGames/" target="_parent" aria-label="Twitter X">
        <div class="social-media-icon-container shiny-btn" set:html={icon(faXTwitter).html[0]} />
      </a>
      <a href="https://discord.petezahgames.com" target="_parent" aria-label="Discord">
        <div class="social-media-icon-container shiny-btn" set:html={icon(faDiscord).html[0]} />
      </a>
    </nav>
  </section>

  <a href={`/iframe.html?url=${highlightedGame.url}`} class="large-image-container-link" aria-label={`Play ${highlightedGame.label}`}>
    <section class="large-image-container">
      <img src={highlightedGame.img || '/storage/images/main/placeholder.png'} alt={highlightedGame.label} class="large-image" id="large-image" />
      <div class="large-image-caption" id="large-image-caption">{highlightedGame.label}</div>
    </section>
  </a>

  <section class="image-shuffler" aria-label="Game Carousel">
    <div class="carousel-container">
      <button id="btn-prev" class="carousel-btn carousel-btn-prev" aria-label="Previous Game" set:html={icon(faChevronLeft).html[0]} />

      <div class="carousel-track">
        {
          carouselGames.map((game: any) => {
            const imgUrl = (game.img || '/storage/images/main/placeholder.png') as string;
            return (
              <article class="carousel-item">
                <a href={`/iframe.html?url=${game.url}`} class="carousel-link" aria-label={`Play ${game.label}`}>
                  <img src={imgUrl} alt={game.label} height="200" width="300" class="image" loading="lazy" />
                  <div class="carousel-item-overlay">{game.label}</div>
                </a>
              </article>
            );
          })
        }
      </div>
    </div>
    <button id="btn-next" class="carousel-btn carousel-btn-next" aria-label="Next Game" set:html={icon(faChevronRight).html[0]} />
  </section>

  <div id="carouselDots" class="carousel-dots"></div>

  <div id="discord-popup" class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-title">
    <div class="popup-content">
      <span id="close-popup" class="close-btn" aria-label="Close popup">Ã—</span>
      <h2 id="popup-title">Want more links and news?</h2>
      <p>Click below to join our Discord community and follow us on Twitter/X to stay updated!</p>
      <div class="discord-btn">
        <a href="https://x.com/PeteZahGames/" target="_parent">
          <div class="social-media-icon-container-2" set:html={icon(faXTwitter).html[0]} />
        </a>
        <a href="https://discord.petezahgames.com" target="_parent">
          <div class="social-media-icon-container-2" set:html={icon(faDiscord).html[0]} />
        </a>
      </div>
    </div>
  </div>

  <aside id="info-box" class="info-box" aria-label="System Info">
    <div class="info-row">
      <span id="battery-display">
        <span class="battery-container" id="battery-wrapper">
          <span id="bat-full" class="bat-icon" style="display:none" set:html={icon(faBatteryFull).html[0]} />
          <span id="bat-three-quarters" class="bat-icon" style="display:none" set:html={icon(faBatteryThreeQuarters).html[0]} />
          <span id="bat-half" class="bat-icon" style="display:none" set:html={icon(faBatteryHalf).html[0]} />
          <span id="bat-quarter" class="bat-icon" style="display:none" set:html={icon(faBatteryQuarter).html[0]} />
          <span id="bat-empty" class="bat-icon" style="display:none" set:html={icon(faBatteryEmpty).html[0]} />
          <span id="bat-loading" class="bat-icon" set:html={icon(faBatteryEmpty).html[0]} />
        </span>
        <span id="battery-percentage">Loading...</span>
      </span>
      <span id="fps">FPS: Calculating...</span>
    </div>
    <div class="info-row">
      <span id="time-display">Time: Loading...</span>
    </div>
    <a href="https://discord.gg/arcgZTV9zX" target="_blank" class="discord-btn-two shiny-btn"> Join Discord</a>
  </aside>

  <style>
    /* Use :global because .wrap is created by JS */
    :global(.typewrite > .wrap) {
      border-right: 0.06em solid #0096ff;
      animation: blink-caret 0.75s step-end infinite;
    }

    @keyframes blink-caret {
      from,
      to {
        border-color: transparent;
      }
      50% {
        border-color: #0096ff;
      }
    }
  </style>

  <script>
    /**
     * Typescript types for battery (Experimental API)
     */
    interface BatteryManager extends EventTarget {
      charging: boolean;
      chargingTime: number;
      dischargingTime: number;
      level: number;
      onchargingchange: ((this: BatteryManager, ev: Event) => any) | null;
      onchargingtimechange: ((this: BatteryManager, ev: Event) => any) | null;
      ondischargingtimechange: ((this: BatteryManager, ev: Event) => any) | null;
      onlevelchange: ((this: BatteryManager, ev: Event) => any) | null;
    }

    interface Navigator {
      getBattery?: () => Promise<BatteryManager>;
    }

    // --- 1. SYSTEM MONITOR (FPS, Time, Battery) ---
    function initSystemMonitor() {
      const timeDisplay = document.getElementById('time-display');
      const batteryWrapper = document.getElementById('battery-wrapper');
      const batteryPercentage = document.getElementById('battery-percentage');
      const fpsElement = document.getElementById('fps');

      let frameCount = 0;
      let lastUpdateTime = performance.now();
      let animFrameId: number;

      // Update Time
      function updateTime() {
        if (!timeDisplay) return;
        const now = new Date();
        timeDisplay.textContent = ` ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      }

      // Update Battery
      function updateBattery() {
        if (!batteryPercentage || !batteryWrapper) return;

        if ('getBattery' in navigator && (navigator as any).getBattery) {
          (navigator as Navigator).getBattery!().then((battery: BatteryManager) => {
            const percentage = Math.round(battery.level * 100);
            batteryPercentage!.textContent = `${percentage}%`;

            batteryWrapper!.className = 'battery-container'; // Reset
            batteryWrapper!.querySelectorAll('.bat-icon').forEach((el) => ((el as HTMLElement).style.display = 'none'));

            let iconId = 'bat-empty';
            let colorClass = 'battery-low';

            if (percentage >= 90) {
              iconId = 'bat-full';
              colorClass = 'battery-full';
            } else if (percentage >= 70) {
              iconId = 'bat-three-quarters';
              colorClass = 'battery-good';
            } else if (percentage >= 50) {
              iconId = 'bat-half';
              colorClass = 'battery-good';
            } else if (percentage >= 30) {
              iconId = 'bat-quarter';
              colorClass = 'battery-medium';
            }

            batteryWrapper!.classList.add(colorClass);
            const activeIcon = document.getElementById(iconId);
            if (activeIcon) activeIcon.style.display = 'inline-block';
          });
        } else {
          batteryPercentage.textContent = 'n/a';
          const loading = document.getElementById('bat-loading');
          if (loading) loading.style.display = 'inline-block';
        }
      }

      // Calculate FPS
      function calculateFPS() {
        frameCount++;
        const now = performance.now();
        const deltaTime = now - lastUpdateTime;

        if (deltaTime >= 1000) {
          if (fpsElement) fpsElement.textContent = `FPS: ${frameCount}`;
          frameCount = 0;
          lastUpdateTime = now;
        }
        animFrameId = requestAnimationFrame(calculateFPS);
      }

      // Initial Calls
      updateTime();
      updateBattery();
      calculateFPS();

      // Intervals
      const timeInterval = setInterval(updateTime, 60000);
      const batInterval = setInterval(updateBattery, 30000);

      // Cleanup function (useful if component unmounts)
      return () => {
        clearInterval(timeInterval);
        clearInterval(batInterval);
        cancelAnimationFrame(animFrameId);
      };
    }

    // --- 2. CAROUSEL LOGIC ---
    function initCarousel() {
      const carouselTrack = document.querySelector('.carousel-track') as HTMLElement;
      const originalItems = document.querySelectorAll('.carousel-item');
      const carouselDots = document.getElementById('carouselDots');
      const btnPrev = document.getElementById('btn-prev');
      const btnNext = document.getElementById('btn-next');

      if (!carouselTrack || originalItems.length === 0) return;

      let itemsPerView = 1;
      let carouselIndex = 0;
      let logicalIndex = 0;
      let isTransitioning = false;
      let slideWidth = 0;
      let totalOriginal = originalItems.length;
      let touchStartX = 0;
      let touchEndX = 0;
      let isDragging = false;

      function setup() {
        const container = document.querySelector('.carousel-container') as HTMLElement;
        const gap = 8;
        const containerWidth = container.clientWidth;
        const sampleItem = originalItems[0] as HTMLElement;
        const itemWidth = sampleItem.offsetWidth;

        slideWidth = itemWidth + gap;
        itemsPerView = Math.floor(containerWidth / slideWidth) || 1;

        carouselTrack.innerHTML = '';
        const fragment = document.createDocumentFragment();

        // Clone Last Items (Prepend)
        for (let i = totalOriginal - itemsPerView; i < totalOriginal; i++) {
          let clone = originalItems[i].cloneNode(true) as HTMLElement;
          clone.classList.add('clone');
          fragment.appendChild(clone);
        }

        // Original Items
        originalItems.forEach((item) => fragment.appendChild(item));

        // Clone First Items (Append)
        for (let i = 0; i < itemsPerView; i++) {
          let clone = originalItems[i].cloneNode(true) as HTMLElement;
          clone.classList.add('clone');
          fragment.appendChild(clone);
        }

        carouselTrack.appendChild(fragment);
        carouselIndex = itemsPerView;
        updateTrackPosition(false);
        updateDots();
      }

      function updateTrackPosition(animate = true) {
        carouselTrack.style.transition = animate ? 'transform 0.3s ease-in-out' : 'none';
        carouselTrack.style.transform = `translateX(-${carouselIndex * slideWidth}px)`;
      }

      function move(direction: number) {
        if (isTransitioning) return;
        isTransitioning = true;
        carouselIndex += direction;

        if (direction === 1) {
          logicalIndex++;
          if (logicalIndex >= totalOriginal) logicalIndex = 0;
        } else {
          logicalIndex--;
          if (logicalIndex < 0) logicalIndex = totalOriginal - 1;
        }

        updateTrackPosition(true);
        updateDots();
      }

      function updateDots() {
        if (!carouselDots) return;
        carouselDots.innerHTML = '';

        for (let i = 0; i < totalOriginal; i++) {
          const dot = document.createElement('div');
          dot.className = `carousel-dot ${i === logicalIndex ? 'active' : ''}`;
          // Event Listener instead of onclick attribute
          dot.addEventListener('click', () => {
            if (isTransitioning) return;
            logicalIndex = i;
            carouselIndex = i + itemsPerView;
            updateTrackPosition(true);
            updateDots();
          });
          carouselDots.appendChild(dot);
        }
      }

      // Transition End Reset
      carouselTrack.addEventListener('transitionend', () => {
        isTransitioning = false;
        if (carouselIndex >= totalOriginal + itemsPerView) {
          carouselIndex = itemsPerView;
          updateTrackPosition(false);
        } else if (carouselIndex < itemsPerView) {
          carouselIndex = totalOriginal + itemsPerView - 1;
          updateTrackPosition(false);
        }
      });

      // Swipe Logic
      function handleSwipe() {
        const threshold = 50;
        const distance = touchStartX - touchEndX;
        if (Math.abs(distance) > threshold) {
          move(distance > 0 ? 1 : -1);
        }
      }

      carouselTrack.addEventListener(
        'touchstart',
        (e) => {
          touchStartX = e.touches[0].clientX;
          isDragging = true;
        },
        { passive: true }
      );
      carouselTrack.addEventListener(
        'touchmove',
        (e) => {
          if (isDragging) touchEndX = e.touches[0].clientX;
        },
        { passive: false }
      );
      carouselTrack.addEventListener(
        'touchend',
        () => {
          if (isDragging) {
            isDragging = false;
            handleSwipe();
          }
        },
        { passive: true }
      );

      // Mouse Drag
      carouselTrack.addEventListener('mousedown', (e) => {
        touchStartX = e.clientX;
        isDragging = true;
      });
      carouselTrack.addEventListener('mousemove', (e) => {
        if (isDragging) touchEndX = e.clientX;
      });
      carouselTrack.addEventListener('mouseup', () => {
        isDragging = false;
        handleSwipe();
      });
      carouselTrack.addEventListener('mouseleave', () => {
        isDragging = false;
      });

      // Button Listeners
      btnPrev?.addEventListener('click', () => move(-1));
      btnNext?.addEventListener('click', () => move(1));

      // Init
      setup();

      // Resize Handler
      let resizeTimer: number;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(setup, 200);
      });
    }

    // --- 3. IMAGE ROTATOR ---
    function initImageRotator() {
      // Use fallback images list - these are the highlighted games
      const images = [
        { src: '/storage/images/main/highway-racer.jpeg', caption: 'Highway Racer' },
        { src: '/storage/images/main/buildnow.jpeg', caption: 'Buildnow.gg' },
        { src: '/storage/ag/g/slope/IMG_5256.jpeg', caption: 'Slope' },
        { src: '/storage/images/main/clash.jpeg', caption: 'Clash Royale' },
        { src: '/storage/images/main/superstarcar.jpeg', caption: 'Superstar Car' },
        { src: '/storage/ag/g/polytrack/splash.png', caption: 'Polytrack' },
        { src: '/storage/images/main/brawlstars1.jpg', caption: 'Brawl Stars' },
        { src: '/storage/ag/g/yohoho/IMG_5302.jpeg', caption: 'YoHoHo!' },
        { src: '/storage/images/main/smashy.jpg', caption: 'Smashy Road' },
        { src: '/storage/images/main/ragdoll.jpg', caption: 'Ragdoll Archers' },
        { src: '/storage/images/main/slitherio.jpg', caption: 'Slither.io' }
      ];

      const imageElement = document.getElementById('large-image') as HTMLImageElement;
      const captionElement = document.getElementById('large-image-caption');
      let currentImgIndex = 0;
      let intervalId: ReturnType<typeof setInterval> | undefined;

      if (imageElement && captionElement) {
        intervalId = setInterval(() => {
          currentImgIndex = (currentImgIndex + 1) % images.length;
          const currentImage = images[currentImgIndex];

          // Preload next image for smoothness (optional optimization)
          const nextImg = new Image();
          nextImg.src = images[(currentImgIndex + 1) % images.length].src;

          imageElement.style.opacity = '0';
          setTimeout(() => {
            imageElement.src = currentImage.src;
            captionElement.textContent = currentImage.caption;
            imageElement.style.opacity = '1';
          }, 200); // Small fade effect if CSS transition exists
        }, 3000);
      }
      return () => clearInterval(intervalId);
    }

    // --- 4. TYPEWRITER ---
    class TxtType {
      el: HTMLElement;
      toRotate: string[];
      period: number;
      txt: string;
      loopNum: number;
      isDeleting: boolean;

      constructor(el: HTMLElement, toRotate: string[], period: string) {
        this.toRotate = toRotate;
        this.el = el;
        this.loopNum = 0;
        this.period = parseInt(period, 10) || 2000;
        this.txt = '';
        this.isDeleting = false;
        this.tick();
      }

      tick() {
        const i = this.loopNum % this.toRotate.length;
        const fullTxt = this.toRotate[i];

        if (this.isDeleting) {
          this.txt = fullTxt.substring(0, this.txt.length - 1);
        } else {
          this.txt = fullTxt.substring(0, this.txt.length + 1);
        }

        this.el.innerHTML = '<span class="wrap">' + this.txt + '</span>';

        let delta = 200 - Math.random() * 100;

        if (this.isDeleting) {
          delta /= 2;
        }

        if (!this.isDeleting && this.txt === fullTxt) {
          delta = this.period;
          this.isDeleting = true;
        } else if (this.isDeleting && this.txt === '') {
          this.isDeleting = false;
          this.loopNum++;
          delta = 500;
        }

        setTimeout(() => this.tick(), delta);
      }
    }

    function initTypewriter() {
      const elements = document.getElementsByClassName('typewrite');
      for (let i = 0; i < elements.length; i++) {
        const toRotate = elements[i].getAttribute('data-type');
        const period = elements[i].getAttribute('data-period');
        if (toRotate) {
          new TxtType(elements[i] as HTMLElement, JSON.parse(toRotate), period || '2000');
        }
      }
    }

    // --- 5. POPUP LOGIC ---
    function initPopup() {
      const popup = document.getElementById('discord-popup');
      const closeBtn = document.getElementById('close-popup');

      if (popup && closeBtn) {
        const lastPopupClose = Number(localStorage.getItem('lastPopupClose'));
        const currentTime = new Date().getTime();

        if (!lastPopupClose || currentTime - lastPopupClose > 3600000) {
          popup.style.display = 'flex';
        }

        closeBtn.addEventListener('click', function () {
          popup.style.display = 'none';
          localStorage.setItem('lastPopupClose', new Date().getTime().toString());
        });
      }
    }

    // --- MASTER INIT ---
    // astro:page-load handles both initial load AND View Transition swaps
    document.addEventListener('astro:page-load', () => {
      document.body.classList.add('loaded'); // Animation trigger

      const cleanupMonitor = initSystemMonitor();
      const cleanupRotator = initImageRotator();

      initCarousel();
      initTypewriter();
      initPopup();

      // Cleanup listeners on swap to prevent memory leaks/duplicate intervals
      document.addEventListener(
        'astro:before-swap',
        () => {
          if (cleanupMonitor) cleanupMonitor();
          if (cleanupRotator) cleanupRotator();
        },
        { once: true }
      );
    });
  </script>
</AppLayout>
