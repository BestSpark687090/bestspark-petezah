---
import { Image } from 'astro:assets';
import AppLayout from '../layouts/AppLayout.astro';
import '../styles/index.css';
// Typewriter Text Data
const typewriterText = [
  'PeteZah Games.',
  'beauty.',
  'vibrancy.',
  'prosperity.',
  'peace.',
  'stability.',
  'amazement.',
  'resiliency.',
  'friendliness.',
  'flourishment.',
  'sustainability.'
];

// Carousel Data
const carouselGames = [
  { label: 'Highway Racer', img: '/storage/images/main/highway-racer.jpeg', url: '/storage/ag/g/highway-racer' },
  { label: 'Buildnow.gg', img: '/storage/images/main/buildnow.jpeg', url: '/storage/ag/g/buildnowgg' },
  { label: 'Slope', img: '/storage/ag/g/slope/IMG_5256.jpeg', url: '/storage/ag/g/slope' },
  { label: 'Clash Royale', img: '/storage/images/main/clash.jpeg', url: '/storage/ag/g/clash-royale' },
  { label: 'Superstar Car', img: '/storage/images/main/superstarcar.jpeg', url: '/storage/ag/g/superstarcar' },
  { label: 'Polytrack', img: '/storage/ag/g/polytrack/splash.png', url: '/storage/ag/g/polytrack' },
  { label: 'Brawl Stars', img: '/storage/images/main/brawlstars1.jpg', url: '/storage/ag/g/brawlstars' },
  { label: 'YoHoHo!', img: '/storage/ag/g/yohoho/IMG_5302.jpeg', url: '/storage/ag/g/yohoho' },
  { label: 'Smashy Road', img: '/storage/images/main/smashy.jpg', url: '/storage/ag/g/smashyroad' },
  { label: 'Ragdoll Archers', img: '/storage/images/main/ragdoll.jpg', url: '/storage/ag/g/ragdoll-archers' },
  { label: 'Slither.io', img: '/storage/images/main/slitherio.jpg', url: '/storage/ag/g/slither' },
  { label: 'Highway Racer', img: '/storage/images/main/highway-racer.jpeg', url: '/storage/ag/g/highway-racer' },
  { label: 'Buildnow.gg', img: '/storage/images/main/buildnow.jpeg', url: '/storage/ag/g/buildnowgg' },
  { label: 'Slope', img: '/storage/ag/g/slope/IMG_5256.jpeg', url: '/storage/ag/g/slope' },
  { label: 'Clash Royale', img: '/storage/images/main/clash.jpeg', url: '/storage/ag/g/clash-royale' },
  { label: 'Superstar Car', img: '/storage/images/main/superstarcar.jpeg', url: '/storage/ag/g/superstarcar' },
  { label: 'Polytrack', img: '/storage/ag/g/polytrack/splash.png', url: '/storage/ag/g/polytrack' },
  { label: 'Brawl Stars', img: '/storage/images/main/brawlstars1.jpg', url: '/storage/ag/g/brawlstars' },
  { label: 'YoHoHo!', img: '/storage/ag/g/yohoho/IMG_5302.jpeg', url: '/storage/ag/g/yohoho' },
  { label: 'Smashy Road', img: '/storage/images/main/smashy.jpg', url: '/storage/ag/g/smashyroad' },
  { label: 'Ragdoll Archers', img: '/storage/images/main/ragdoll.jpg', url: '/storage/ag/g/ragdoll-archers' },
  { label: 'Slither.io', img: '/storage/images/main/slitherio.jpg', url: '/storage/ag/g/slither' }
];

const highlightedGame = {
  label: 'Highway Racer',
  img: '/storage/images/main/highway-racer.jpeg',
  url: '/storage/ag/g/highway-racer'
};
---

<AppLayout title="Home">
  <!-- Background Effects -->
  <div class="god-rays" aria-hidden="true"></div>

  <!-- Main Content Wrapper -->
  <main>
    <!-- Welcome Section -->
    <section class="welcome-section" aria-label="Welcome">
      <h2>
        Welcome to
        <br />
        <span class="gradient-text">
          <span class="typewrite" data-period="2000" data-type={JSON.stringify(typewriterText)}>
            <span class="wrap"></span>
          </span>
        </span>
      </h2>
      <p>Game on!</p>

      <a href="/games" class="shiny-btn start-btn">
        <span>Start Gaming</span>
      </a>

      <!-- Social Media Navigation -->
      <nav class="social-media-tray" aria-label="Social Media Links">
        <a href="https://x.com/PeteZahGames/" target="_parent" aria-label="Twitter X">
          <div class="social-media-icon-container shiny-btn">
            <i class="fa-brands fa-x-twitter"></i>
          </div>
        </a>
        <a href="https://discord.petezahgames.com" target="_parent" aria-label="Discord">
          <div class="social-media-icon-container shiny-btn">
            <i class="fa-brands fa-discord"></i>
          </div>
        </a>
      </nav>
    </section>

    <!-- Featured Game Link -->
    <a href={`/iframe.html?url=${highlightedGame.url}`} class="large-image-container-link" aria-label={`Play ${highlightedGame.label}`}>
      <section class="large-image-container">
        <img src={highlightedGame.img} alt={highlightedGame.label} class="large-image" id="large-image" />
        <div class="large-image-caption" id="large-image-caption">{highlightedGame.label}</div>
      </section>
    </a>

    <!-- Carousel Section -->
    <section class="image-shuffler" aria-label="Game Carousel">
      <div class="carousel-container">
        <button class="carousel-btn carousel-btn-prev" onclick="moveCarousel(-1)" aria-label="Previous Game">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div class="carousel-track">
          {
            carouselGames.map((game) => (
              <article class="carousel-item">
                <a href={`/iframe.html?url=${game.url}`} class="carousel-link" aria-label={`Play ${game.label}`}>
                  <Image src={game.img} alt={game.label} height="2" width="3" class="image" loading="eager" />
                  <div class="carousel-item-overlay">{game.label}</div>
                </a>
              </article>
            ))
          }
        </div>
      </div>
      <button class="carousel-btn carousel-btn-next" onclick="moveCarousel(1)" aria-label="Next Game">
        <i class="fas fa-chevron-right"></i>
      </button>
    </section>
  </main>

  <!-- Popup -->
  <div id="discord-popup" class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-title">
    <div class="popup-content">
      <span id="close-popup" class="close-btn" aria-label="Close popup">Ã—</span>
      <h2 id="popup-title">Want more links and news?</h2>
      <p>Click below to join our Discord community and follow us on Twitter/X to stay updated!</p>
      <div class="discord-btn">
        <a href="https://x.com/PeteZahGames/" target="_parent">
          <div class="social-media-icon-container-2">
            <i class="fa-brands fa-x-twitter"></i>
          </div>
        </a>
        <a href="https://discord.petezahgames.com" target="_parent">
          <div class="social-media-icon-container-2">
            <i class="fa-brands fa-discord"></i>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Footer / Info Box -->
  <aside id="info-box" class="info-box" aria-label="System Info">
    <div class="info-row">
      <span id="battery-display">
        <span class="battery-container">
          <i id="battery-icon" class="fas fa-battery-full battery-icon"></i>
        </span>
        <span id="battery-percentage">Loading...</span>
      </span>
      <span id="fps">FPS: Calculating...</span>
    </div>
    <div class="info-row">
      <span id="time-display">Time: Loading...</span>
    </div>
    <a href="https://discord.gg/arcgZTV9zX" target="_blank" class="discord-btn-two shiny-btn"> Join Discord</a>
  </aside>

  <script>
    // --- General Page Load ---
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(() => {
        document.body.classList.add('loaded');
      }, 1000);
    });

    // --- INFINITE CAROUSEL LOGIC ---
    const carouselTrack = document.querySelector('.carousel-track');
    // Select all ORIGINAL items immediately (before cloning)
    const originalItems = document.querySelectorAll('.carousel-item');
    const carouselDots = document.getElementById('carouselDots');

    let itemsPerView = 1;
    let carouselIndex = 0; // The visual index (including clones)
    let logicalIndex = 0; // The actual data index (0 to total-1)
    let isTransitioning = false;
    let slideWidth = 0;
    let totalOriginal = originalItems.length;

    // Touch variables
    let touchStartX = 0;
    let touchEndX = 0;
    let isDragging = false;

    function initCarousel() {
      if (!carouselTrack || originalItems.length === 0) return;

      // 1. Calculate dimensions
      const container = document.querySelector('.carousel-container');
      const gap = 8; // CSS gap
      const containerWidth = container.clientWidth;
      // Measure one item to determine how many fit
      const sampleItem = originalItems[0];
      const itemWidth = sampleItem.offsetWidth;

      slideWidth = itemWidth + gap;
      itemsPerView = Math.floor(containerWidth / slideWidth);
      if (itemsPerView < 1) itemsPerView = 1;

      // 2. Clear existing track to prevent duplicate clones on resize
      carouselTrack.innerHTML = '';

      // 3. Create Clones
      // We clone 'itemsPerView' amount of items for both ends to ensure no whitespace during transition
      const fragment = document.createDocumentFragment();

      // Prepend clones (Last 'n' items)
      for (let i = totalOriginal - itemsPerView; i < totalOriginal; i++) {
        let idx = (i + totalOriginal) % totalOriginal; // Handle negative wrap safety
        let clone = originalItems[idx].cloneNode(true);
        clone.classList.add('clone');
        fragment.appendChild(clone);
      }

      // Add Original Items
      originalItems.forEach((item) => fragment.appendChild(item));

      // Append clones (First 'n' items)
      for (let i = 0; i < itemsPerView; i++) {
        let clone = originalItems[i].cloneNode(true);
        clone.classList.add('clone');
        fragment.appendChild(clone);
      }

      carouselTrack.appendChild(fragment);

      // 4. Set Initial Position (Skip the first set of clones)
      carouselIndex = itemsPerView;
      updateTrackPosition(false); // false = no animation
      updateCarouselDots();
    }

    function updateTrackPosition(animate = true) {
      if (animate) {
        carouselTrack.style.transition = 'transform 0.3s ease-in-out';
      } else {
        carouselTrack.style.transition = 'none';
      }
      carouselTrack.style.transform = `translateX(-${carouselIndex * slideWidth}px)`;
    }

    function moveCarousel(direction) {
      if (isTransitioning) return;
      isTransitioning = true;

      carouselIndex += direction;

      // Calculate logical index for dots
      if (direction === 1) {
        logicalIndex++;
        if (logicalIndex >= totalOriginal) logicalIndex = 0;
      } else {
        logicalIndex--;
        if (logicalIndex < 0) logicalIndex = totalOriginal - 1;
      }

      updateTrackPosition(true);
      updateCarouselDots();
    }

    // Handle the "Loop" when transition finishes
    carouselTrack?.addEventListener('transitionend', () => {
      isTransitioning = false;

      // If we scrolled past the last real item (into appended clones)
      if (carouselIndex >= totalOriginal + itemsPerView) {
        carouselIndex = itemsPerView; // Snap to start
        updateTrackPosition(false);
      }
      // If we scrolled before the first real item (into prepended clones)
      else if (carouselIndex < itemsPerView) {
        carouselIndex = totalOriginal + itemsPerView - 1; // Snap to end
        updateTrackPosition(false);
      }
    });

    function updateCarouselDots() {
      if (!carouselDots) return;
      // Ensure logical index is always safe
      let activeDot = logicalIndex;

      // Generate dots based on TOTAL ORIGINAL items (minus those that don't need a scroll if desired, but usually 1 dot per item for infinite)
      const dotsHtml = Array.from(
        { length: totalOriginal },
        (_, i) => `<div class="carousel-dot ${i === activeDot ? 'active' : ''}" onclick="goToCarouselSlide(${i})"></div>`
      ).join('');

      carouselDots.innerHTML = dotsHtml;
    }

    window.goToCarouselSlide = function (index) {
      // Make global for onclick
      if (isTransitioning) return;
      logicalIndex = index;
      carouselIndex = index + itemsPerView; // Add offset for clones
      updateTrackPosition(true);
      updateCarouselDots();
    };

    // --- Touch / Swipe Logic ---
    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      isDragging = true;
    }
    function handleTouchMove(e) {
      if (!isDragging) return;
      touchEndX = e.touches[0].clientX;
    }
    function handleTouchEnd() {
      if (!isDragging) return;
      isDragging = false;
      handleSwipe();
    }
    function handleMouseDown(e) {
      touchStartX = e.clientX;
      isDragging = true;
    }
    function handleMouseMove(e) {
      if (!isDragging) return;
      touchEndX = e.clientX;
    }
    function handleMouseUp() {
      isDragging = false;
      handleSwipe();
    }

    function handleSwipe() {
      const swipeThreshold = 50;
      const swipeDistance = touchStartX - touchEndX;
      if (Math.abs(swipeDistance) > swipeThreshold) {
        if (swipeDistance > 0) {
          moveCarousel(1); // Next
        } else {
          moveCarousel(-1); // Prev
        }
      }
    }

    // Initialize Carousel
    document.addEventListener('DOMContentLoaded', function () {
      initCarousel();

      // Event Listeners
      carouselTrack.addEventListener('touchstart', handleTouchStart, { passive: true });
      carouselTrack.addEventListener('touchmove', handleTouchMove, { passive: false });
      carouselTrack.addEventListener('touchend', handleTouchEnd, { passive: true });
      carouselTrack.addEventListener('mousedown', handleMouseDown);
      carouselTrack.addEventListener('mousemove', handleMouseMove);
      carouselTrack.addEventListener('mouseup', handleMouseUp);
      carouselTrack.addEventListener('mouseleave', handleMouseUp);
    });

    // Handle Resize
    window.addEventListener('resize', function () {
      clearTimeout(window.resizeTimer);
      window.resizeTimer = setTimeout(() => {
        // Reset to original state to recalculate properly
        initCarousel();
      }, 200);
    });

    // --- REST OF THE UTILITIES (Typewriter, Battery, etc) ---

    // Image Caption Rotator
    const images = [
      { src: '/storage/images/main/highway-racer.jpeg', caption: 'Highway Racer' },
      { src: '/storage/images/main/buildnow.jpeg', caption: 'Buildnow.gg' },
      { src: '/storage/ag/g/slope/IMG_5256.jpeg', caption: 'Slope' },
      { src: '/storage/images/main/clash.jpeg', caption: 'Clash Royale' },
      { src: '/storage/images/main/superstarcar.jpeg', caption: 'Superstar Car' },
      { src: '/storage/ag/g/yohoho/IMG_5302.jpeg', caption: 'YoHoHo!' }
    ];

    let currentImgIndex = 0;
    const imageElement = document.getElementById('large-image');
    const captionElement = document.getElementById('large-image-caption');

    if (imageElement && captionElement) {
      function changeImage() {
        currentImgIndex = (currentImgIndex + 1) % images.length;
        const currentImage = images[currentImgIndex];
        imageElement.src = currentImage.src;
        captionElement.textContent = currentImage.caption;
      }
      setInterval(changeImage, 3000);
    }

    // Typewriter Effect
    class TxtType {
      constructor(el, toRotate, period) {
        this.toRotate = toRotate;
        this.el = el;
        this.loopNum = 0;
        this.period = parseInt(period, 10) || 2000;
        this.txt = '';
        this.tick();
        this.isDeleting = false;
      }

      tick() {
        const i = this.loopNum % this.toRotate.length;
        const fullTxt = this.toRotate[i];

        if (this.isDeleting) {
          this.txt = fullTxt.substring(0, this.txt.length - 1);
        } else {
          this.txt = fullTxt.substring(0, this.txt.length + 1);
        }

        this.el.innerHTML = '<span class="wrap">' + this.txt + '</span>';

        let delta = 200 - Math.random() * 100;

        if (this.isDeleting) {
          delta /= 2;
        }

        if (!this.isDeleting && this.txt === fullTxt) {
          delta = this.period;
          this.isDeleting = true;
        } else if (this.isDeleting && this.txt === '') {
          this.isDeleting = false;
          this.loopNum++;
          delta = 500;
        }

        setTimeout(() => this.tick(), delta);
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const elements = document.getElementsByClassName('typewrite');
      for (let i = 0; i < elements.length; i++) {
        const toRotate = elements[i].getAttribute('data-type');
        const period = elements[i].getAttribute('data-period');
        if (toRotate) {
          new TxtType(elements[i], JSON.parse(toRotate), period);
        }
      }
      const css = document.createElement('style');
      css.type = 'text/css';
      css.innerHTML = '.typewrite > .wrap { border-right: 0.06em solid #0096FF}';
      document.body.appendChild(css);
    });

    // Popup Logic
    document.addEventListener('DOMContentLoaded', function () {
      const popup = document.getElementById('discord-popup');
      const closeBtn = document.getElementById('close-popup');

      if (popup && closeBtn) {
        function checkPopup() {
          const lastPopupClose = localStorage.getItem('lastPopupClose');
          const currentTime = new Date().getTime();
          if (!lastPopupClose || currentTime - lastPopupClose > 3600000) {
            popup.style.display = 'flex';
          }
        }
        closeBtn.addEventListener('click', function () {
          popup.style.display = 'none';
          localStorage.setItem('lastPopupClose', new Date().getTime());
        });
        checkPopup();
      }
    });

    // System Stats (Time, Battery, FPS)
    document.addEventListener('DOMContentLoaded', function () {
      const timeDisplay = document.getElementById('time-display');
      const batteryIcon = document.getElementById('battery-icon');
      const batteryPercentage = document.getElementById('battery-percentage');
      const fpsElement = document.getElementById('fps');

      let frameCount = 0;
      let lastUpdateTime = performance.now();

      function updateTime() {
        if (!timeDisplay) return;
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
        timeDisplay.textContent = ` ${timeString}`;
      }

      function updateBattery() {
        if (!batteryPercentage || !batteryIcon) return;
        if ('getBattery' in navigator) {
          navigator.getBattery().then(function (battery) {
            const level = battery.level * 100;
            const percentage = Math.round(level);

            batteryPercentage.textContent = `${percentage}%`;

            batteryIcon.className = 'fas battery-icon';
            if (percentage >= 90) {
              batteryIcon.classList.add('fa-battery-full', 'battery-full');
            } else if (percentage >= 70) {
              batteryIcon.classList.add('fa-battery-three-quarters', 'battery-good');
            } else if (percentage >= 50) {
              batteryIcon.classList.add('fa-battery-half', 'battery-good');
            } else if (percentage >= 30) {
              batteryIcon.classList.add('fa-battery-quarter', 'battery-medium');
            } else if (percentage >= 10) {
              batteryIcon.classList.add('fa-battery-empty', 'battery-low');
            } else {
              batteryIcon.classList.add('fa-battery-empty', 'battery-low');
            }
          });
        } else {
          batteryPercentage.textContent = 'n/a';
          batteryIcon.className = 'fas fa-battery-slash battery-icon';
        }
      }

      function calculateFPS() {
        if (!fpsElement) return;
        frameCount++;
        const now = performance.now();
        const deltaTime = now - lastUpdateTime;

        if (deltaTime >= 1000) {
          const fps = frameCount;
          fpsElement.textContent = `FPS: ${fps}`;
          frameCount = 0;
          lastUpdateTime = now;
        }
        requestAnimationFrame(calculateFPS);
      }

      updateTime();
      updateBattery();
      requestAnimationFrame(calculateFPS);

      setInterval(updateTime, 60000);
      setInterval(updateBattery, 30000);
    });
  </script>

  <script src="/storage/js/settings.js" is:inline></script>
</AppLayout>
