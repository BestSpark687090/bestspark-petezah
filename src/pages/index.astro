---
import { Picture } from 'astro:assets';
import AppLayout from '../layouts/AppLayout.astro';
import '../styles/index.css';

// --- FontAwesome Integration (SVG Core) ---
import '@fortawesome/fontawesome-svg-core/styles.css';
import { library, icon, config } from '@fortawesome/fontawesome-svg-core';
import { faXTwitter, faDiscord } from '@fortawesome/free-brands-svg-icons';
import {
  faChevronLeft,
  faChevronRight,
  faBatteryFull,
  faBatteryThreeQuarters,
  faBatteryHalf,
  faBatteryQuarter,
  faBatteryEmpty
} from '@fortawesome/free-solid-svg-icons';

// Prevent FontAwesome from automatically adding CSS to the head
config.autoAddCss = false;

// Add icons to library (Good practice, though we use direct object reference below)
library.add(
  faXTwitter,
  faDiscord,
  faChevronLeft,
  faChevronRight,
  faBatteryFull,
  faBatteryThreeQuarters,
  faBatteryHalf,
  faBatteryQuarter,
  faBatteryEmpty
);

// Typewriter Text Data
const typewriterText = [
  'PeteZah Games.',
  'beauty.',
  'vibrancy.',
  'prosperity.',
  'peace.',
  'stability.',
  'amazement.',
  'resiliency.',
  'friendliness.',
  'flourishment.',
  'sustainability.'
];

const carouselGames = [
  { label: 'Highway Racer', img: '/storage/images/main/highway-racer.jpeg', url: '/storage/ag/g/highway-racer' },
  { label: 'Buildnow.gg', img: '/storage/images/main/buildnow.jpeg', url: '/storage/ag/g/buildnowgg' },
  { label: 'Slope', img: '/storage/ag/g/slope/IMG_5256.jpeg', url: '/storage/ag/g/slope' },
  { label: 'Clash Royale', img: '/storage/images/main/clash.jpeg', url: '/storage/ag/g/clash-royale' },
  { label: 'Superstar Car', img: '/storage/images/main/superstarcar.jpeg', url: '/storage/ag/g/superstarcar' },
  { label: 'Polytrack', img: '/storage/ag/g/polytrack/splash.png', url: '/storage/ag/g/polytrack' },
  { label: 'Brawl Stars', img: '/storage/images/main/brawlstars1.jpg', url: '/storage/ag/g/brawlstars' },
  { label: 'YoHoHo!', img: '/storage/ag/g/yohoho/IMG_5302.jpeg', url: '/storage/ag/g/yohoho' },
  { label: 'Smashy Road', img: '/storage/images/main/smashy.jpg', url: '/storage/ag/g/smashyroad' },
  { label: 'Ragdoll Archers', img: '/storage/images/main/ragdoll.jpg', url: '/storage/ag/g/ragdoll-archers' },
  { label: 'Slither.io', img: '/storage/images/main/slitherio.jpg', url: '/storage/ag/g/slither' },
  { label: 'Highway Racer', img: '/storage/images/main/highway-racer.jpeg', url: '/storage/ag/g/highway-racer' },
  { label: 'Buildnow.gg', img: '/storage/images/main/buildnow.jpeg', url: '/storage/ag/g/buildnowgg' },
  { label: 'Slope', img: '/storage/ag/g/slope/IMG_5256.jpeg', url: '/storage/ag/g/slope' },
  { label: 'Clash Royale', img: '/storage/images/main/clash.jpeg', url: '/storage/ag/g/clash-royale' },
  { label: 'Superstar Car', img: '/storage/images/main/superstarcar.jpeg', url: '/storage/ag/g/superstarcar' },
  { label: 'Polytrack', img: '/storage/ag/g/polytrack/splash.png', url: '/storage/ag/g/polytrack' },
  { label: 'Brawl Stars', img: '/storage/images/main/brawlstars1.jpg', url: '/storage/ag/g/brawlstars' },
  { label: 'YoHoHo!', img: '/storage/ag/g/yohoho/IMG_5302.jpeg', url: '/storage/ag/g/yohoho' },
  { label: 'Smashy Road', img: '/storage/images/main/smashy.jpg', url: '/storage/ag/g/smashyroad' },
  { label: 'Ragdoll Archers', img: '/storage/images/main/ragdoll.jpg', url: '/storage/ag/g/ragdoll-archers' },
  { label: 'Slither.io', img: '/storage/images/main/slitherio.jpg', url: '/storage/ag/g/slither' }
];

const highlightedGame = {
  label: 'Highway Racer',
  img: '/storage/images/main/highway-racer.jpeg',
  url: '/storage/ag/g/highway-racer'
};
---

<AppLayout title="Home">
  <div class="god-rays" aria-hidden="true"></div>

  <main>
    <section class="welcome-section" aria-label="Welcome">
      <h2>
        Welcome to
        <br />
        <span class="gradient-text">
          <span class="typewrite" data-period="2000" data-type={JSON.stringify(typewriterText)}>
            <span class="wrap"></span>
          </span>
        </span>
      </h2>
      <p>Game on!</p>

      <a href="/games" class="shiny-btn start-btn">
        <span>Start Gaming</span>
      </a>

      <nav class="social-media-tray" aria-label="Social Media Links">
        <a href="https://x.com/PeteZahGames/" target="_parent" aria-label="Twitter X">
          <div class="social-media-icon-container shiny-btn" set:html={icon(faXTwitter).html[0]} />
        </a>
        <a href="https://discord.petezahgames.com" target="_parent" aria-label="Discord">
          <div class="social-media-icon-container shiny-btn" set:html={icon(faDiscord).html[0]} />
        </a>
      </nav>
    </section>

    <a href={`/iframe.html?url=${highlightedGame.url}`} class="large-image-container-link" aria-label={`Play ${highlightedGame.label}`}>
      <section class="large-image-container">
        <img src={highlightedGame.img} alt={highlightedGame.label} class="large-image" id="large-image" />
        <div class="large-image-caption" id="large-image-caption">{highlightedGame.label}</div>
      </section>
    </a>

    <section class="image-shuffler" aria-label="Game Carousel">
      <div class="carousel-container">
        <button class="carousel-btn carousel-btn-prev" onclick="moveCarousel(-1)" aria-label="Previous Game" set:html={icon(faChevronLeft).html[0]} />

        <div class="carousel-track">
          {
            carouselGames.map((game) => (
              <article class="carousel-item">
                <a href={`/iframe.html?url=${game.url}`} class="carousel-link" aria-label={`Play ${game.label}`}>
                  <Picture src={game.img} alt={game.label} formats={['avif', 'webp', 'png']} height="2" width="3" class="image" loading="eager" />
                  <div class="carousel-item-overlay">{game.label}</div>
                </a>
              </article>
            ))
          }
        </div>
      </div>
      <button class="carousel-btn carousel-btn-next" onclick="moveCarousel(1)" aria-label="Next Game" set:html={icon(faChevronRight).html[0]} />
    </section>
  </main>

  <div id="discord-popup" class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-title">
    <div class="popup-content">
      <span id="close-popup" class="close-btn" aria-label="Close popup">Ã—</span>
      <h2 id="popup-title">Want more links and news?</h2>
      <p>Click below to join our Discord community and follow us on Twitter/X to stay updated!</p>
      <div class="discord-btn">
        <a href="https://x.com/PeteZahGames/" target="_parent">
          <div class="social-media-icon-container-2" set:html={icon(faXTwitter).html[0]} />
        </a>
        <a href="https://discord.petezahgames.com" target="_parent">
          <div class="social-media-icon-container-2" set:html={icon(faDiscord).html[0]} />
        </a>
      </div>
    </div>
  </div>

  <aside id="info-box" class="info-box" aria-label="System Info">
    <div class="info-row">
      <span id="battery-display">
        <span class="battery-container" id="battery-wrapper">
          <span id="bat-full" class="bat-icon" style="display:none" set:html={icon(faBatteryFull).html[0]} />
          <span id="bat-three-quarters" class="bat-icon" style="display:none" set:html={icon(faBatteryThreeQuarters).html[0]} />
          <span id="bat-half" class="bat-icon" style="display:none" set:html={icon(faBatteryHalf).html[0]} />
          <span id="bat-quarter" class="bat-icon" style="display:none" set:html={icon(faBatteryQuarter).html[0]} />
          <span id="bat-empty" class="bat-icon" style="display:none" set:html={icon(faBatteryEmpty).html[0]} />
          <span id="bat-loading" class="bat-icon" set:html={icon(faBatteryEmpty).html[0]} />
        </span>
        <span id="battery-percentage">Loading...</span>
      </span>
      <span id="fps">FPS: Calculating...</span>
    </div>
    <div class="info-row">
      <span id="time-display">Time: Loading...</span>
    </div>
    <a href="https://discord.gg/arcgZTV9zX" target="_blank" class="discord-btn-two shiny-btn"> Join Discord</a>
  </aside>

  <script>
    /**
     * Typescript types for battery
     */
    interface BatteryManager extends EventTarget {
      charging: boolean;
      chargingTime: number;
      dischargingTime: number;
      level: number;
      onchargingchange: ((this: BatteryManager, ev: Event) => any) | null;
      onchargingtimechange: ((this: BatteryManager, ev: Event) => any) | null;
      ondischargingtimechange: ((this: BatteryManager, ev: Event) => any) | null;
      onlevelchange: ((this: BatteryManager, ev: Event) => any) | null;
    }

    interface Navigator {
      getBattery?: () => Promise<BatteryManager>;
    }

    // --- General Page Load ---
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(() => {
        document.body.classList.add('loaded');
      }, 1000);
    });

    // --- INFINITE CAROUSEL LOGIC ---
    const carouselTrack = document.querySelector('.carousel-track');
    const originalItems = document.querySelectorAll('.carousel-item');
    const carouselDots = document.getElementById('carouselDots');

    let itemsPerView = 1;
    let carouselIndex = 0;
    let logicalIndex = 0;
    let isTransitioning = false;
    let slideWidth = 0;
    let totalOriginal = originalItems.length;

    // Touch variables
    let touchStartX = 0;
    let touchEndX = 0;
    let isDragging = false;

    function initCarousel() {
      if (!carouselTrack || originalItems.length === 0) return;

      const container = document.querySelector('.carousel-container');
      const gap = 8;
      const containerWidth = container.clientWidth;
      const sampleItem = originalItems[0];
      const itemWidth = sampleItem.offsetWidth;

      slideWidth = itemWidth + gap;
      itemsPerView = Math.floor(containerWidth / slideWidth);
      if (itemsPerView < 1) itemsPerView = 1;

      carouselTrack.innerHTML = '';

      const fragment = document.createDocumentFragment();

      for (let i = totalOriginal - itemsPerView; i < totalOriginal; i++) {
        let idx = (i + totalOriginal) % totalOriginal;
        let clone = originalItems[idx].cloneNode(true);
        clone.classList.add('clone');
        fragment.appendChild(clone);
      }

      originalItems.forEach((item) => fragment.appendChild(item));

      for (let i = 0; i < itemsPerView; i++) {
        let clone = originalItems[i].cloneNode(true);
        clone.classList.add('clone');
        fragment.appendChild(clone);
      }

      carouselTrack.appendChild(fragment);

      carouselIndex = itemsPerView;
      updateTrackPosition(false);
      updateCarouselDots();
    }

    function updateTrackPosition(animate = true) {
      if (animate) {
        carouselTrack.style.transition = 'transform 0.3s ease-in-out';
      } else {
        carouselTrack.style.transition = 'none';
      }
      carouselTrack.style.transform = `translateX(-${carouselIndex * slideWidth}px)`;
    }

    function moveCarousel(direction) {
      if (isTransitioning) return;
      isTransitioning = true;

      carouselIndex += direction;

      if (direction === 1) {
        logicalIndex++;
        if (logicalIndex >= totalOriginal) logicalIndex = 0;
      } else {
        logicalIndex--;
        if (logicalIndex < 0) logicalIndex = totalOriginal - 1;
      }

      updateTrackPosition(true);
      updateCarouselDots();
    }

    carouselTrack?.addEventListener('transitionend', () => {
      isTransitioning = false;

      if (carouselIndex >= totalOriginal + itemsPerView) {
        carouselIndex = itemsPerView;
        updateTrackPosition(false);
      } else if (carouselIndex < itemsPerView) {
        carouselIndex = totalOriginal + itemsPerView - 1;
        updateTrackPosition(false);
      }
    });

    function updateCarouselDots() {
      if (!carouselDots) return;
      let activeDot = logicalIndex;

      const dotsHtml = Array.from(
        { length: totalOriginal },
        (_, i) => `<div class="carousel-dot ${i === activeDot ? 'active' : ''}" onclick="goToCarouselSlide(${i})"></div>`
      ).join('');

      carouselDots.innerHTML = dotsHtml;
    }

    window.goToCarouselSlide = function (index) {
      if (isTransitioning) return;
      logicalIndex = index;
      carouselIndex = index + itemsPerView;
      updateTrackPosition(true);
      updateCarouselDots();
    };

    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      isDragging = true;
    }
    function handleTouchMove(e) {
      if (!isDragging) return;
      touchEndX = e.touches[0].clientX;
    }
    function handleTouchEnd() {
      if (!isDragging) return;
      isDragging = false;
      handleSwipe();
    }
    function handleMouseDown(e) {
      touchStartX = e.clientX;
      isDragging = true;
    }
    function handleMouseMove(e) {
      if (!isDragging) return;
      touchEndX = e.clientX;
    }
    function handleMouseUp() {
      isDragging = false;
      handleSwipe();
    }

    function handleSwipe() {
      const swipeThreshold = 50;
      const swipeDistance = touchStartX - touchEndX;
      if (Math.abs(swipeDistance) > swipeThreshold) {
        if (swipeDistance > 0) {
          moveCarousel(1);
        } else {
          moveCarousel(-1);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      initCarousel();
      carouselTrack.addEventListener('touchstart', handleTouchStart, { passive: true });
      carouselTrack.addEventListener('touchmove', handleTouchMove, { passive: false });
      carouselTrack.addEventListener('touchend', handleTouchEnd, { passive: true });
      carouselTrack.addEventListener('mousedown', handleMouseDown);
      carouselTrack.addEventListener('mousemove', handleMouseMove);
      carouselTrack.addEventListener('mouseup', handleMouseUp);
      carouselTrack.addEventListener('mouseleave', handleMouseUp);
    });

    window.addEventListener('resize', function () {
      clearTimeout(window.resizeTimer);
      window.resizeTimer = setTimeout(() => {
        initCarousel();
      }, 200);
    });

    // --- REST OF THE UTILITIES ---

    const images = [
      { src: '/storage/images/main/highway-racer.jpeg', caption: 'Highway Racer' },
      { src: '/storage/images/main/buildnow.jpeg', caption: 'Buildnow.gg' },
      { src: '/storage/ag/g/slope/IMG_5256.jpeg', caption: 'Slope' },
      { src: '/storage/images/main/clash.jpeg', caption: 'Clash Royale' },
      { src: '/storage/images/main/superstarcar.jpeg', caption: 'Superstar Car' },
      { src: '/storage/ag/g/yohoho/IMG_5302.jpeg', caption: 'YoHoHo!' }
    ];

    let currentImgIndex = 0;
    const imageElement = document.getElementById('large-image');
    const captionElement = document.getElementById('large-image-caption');

    if (imageElement && captionElement) {
      function changeImage() {
        currentImgIndex = (currentImgIndex + 1) % images.length;
        const currentImage = images[currentImgIndex];
        imageElement.src = currentImage.src;
        captionElement.textContent = currentImage.caption;
      }
      setInterval(changeImage, 3000);
    }

    class TxtType {
      constructor(el, toRotate, period) {
        this.toRotate = toRotate;
        this.el = el;
        this.loopNum = 0;
        this.period = parseInt(period, 10) || 2000;
        this.txt = '';
        this.tick();
        this.isDeleting = false;
      }

      tick() {
        const i = this.loopNum % this.toRotate.length;
        const fullTxt = this.toRotate[i];

        if (this.isDeleting) {
          this.txt = fullTxt.substring(0, this.txt.length - 1);
        } else {
          this.txt = fullTxt.substring(0, this.txt.length + 1);
        }

        this.el.innerHTML = '<span class="wrap">' + this.txt + '</span>';

        let delta = 200 - Math.random() * 100;

        if (this.isDeleting) {
          delta /= 2;
        }

        if (!this.isDeleting && this.txt === fullTxt) {
          delta = this.period;
          this.isDeleting = true;
        } else if (this.isDeleting && this.txt === '') {
          this.isDeleting = false;
          this.loopNum++;
          delta = 500;
        }

        setTimeout(() => this.tick(), delta);
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const elements = document.getElementsByClassName('typewrite');
      for (let i = 0; i < elements.length; i++) {
        const toRotate = elements[i].getAttribute('data-type');
        const period = elements[i].getAttribute('data-period');
        if (toRotate) {
          new TxtType(elements[i], JSON.parse(toRotate), period);
        }
      }
      const css = document.createElement('style');
      css.type = 'text/css';
      css.innerHTML = '.typewrite > .wrap { border-right: 0.06em solid #0096FF}';
      document.body.appendChild(css);
    });

    document.addEventListener('DOMContentLoaded', function () {
      const popup = document.getElementById('discord-popup');
      const closeBtn = document.getElementById('close-popup');

      if (popup && closeBtn) {
        function checkPopup() {
          const lastPopupClose = Number(localStorage.getItem('lastPopupClose'));
          const currentTime = new Date().getTime();
          if (!lastPopupClose || currentTime - lastPopupClose > 3600000) {
            popup.style.display = 'flex';
          }
        }
        closeBtn.addEventListener('click', function () {
          popup.style.display = 'none';
          localStorage.setItem('lastPopupClose', new Date().getTime().toString());
        });
        checkPopup();
      }
    });

    // --- SYSTEM STATS (With New Battery Logic) ---
    document.addEventListener('DOMContentLoaded', function () {
      const timeDisplay = document.getElementById('time-display');
      const batteryWrapper = document.getElementById('battery-wrapper'); // The container
      const batteryPercentage = document.getElementById('battery-percentage');
      const fpsElement = document.getElementById('fps');

      let frameCount = 0;
      let lastUpdateTime = performance.now();

      function updateTime() {
        if (!timeDisplay) return;
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
        timeDisplay.textContent = ` ${timeString}`;
      }

      function updateBattery() {
        if (!batteryPercentage || !batteryWrapper) return;

        if ('getBattery' in navigator) {
          (navigator as Navigator).getBattery().then(function (battery: BatteryManager) {
            const level = battery.level * 100;
            const percentage = Math.round(level);

            batteryPercentage.textContent = `${percentage}%`;

            // 1. Reset Classes on Wrapper (remove old colors)
            batteryWrapper.className = 'battery-container'; // Reset to base class

            // 2. Hide all icons first
            const allIcons = batteryWrapper.querySelectorAll('.bat-icon');
            allIcons.forEach((el) => ((el as HTMLElement).style.display = 'none'));

            // 3. Determine ID and Color Class
            let iconId = 'bat-empty';
            let colorClass = 'battery-low';

            if (percentage >= 90) {
              iconId = 'bat-full';
              colorClass = 'battery-full'; // Green
            } else if (percentage >= 70) {
              iconId = 'bat-three-quarters';
              colorClass = 'battery-good'; // Green/Yellow
            } else if (percentage >= 50) {
              iconId = 'bat-half';
              colorClass = 'battery-good';
            } else if (percentage >= 30) {
              iconId = 'bat-quarter';
              colorClass = 'battery-medium'; // Orange
            } else {
              iconId = 'bat-empty';
              colorClass = 'battery-low'; // Red
            }

            // 4. Apply changes
            batteryWrapper.classList.add(colorClass); // Apply color to container (cascades to SVG)
            const activeIcon = document.getElementById(iconId);
            if (activeIcon) activeIcon.style.display = 'inline-block';
          });
        } else {
          batteryPercentage.textContent = 'n/a';
          // Fallback view
          const allIcons = batteryWrapper.querySelectorAll('.bat-icon');
          allIcons.forEach((el) => ((el as HTMLElement).style.display = 'none'));
          const loadingIcon = document.getElementById('bat-loading');
          if (loadingIcon) loadingIcon.style.display = 'inline-block';
        }
      }

      function calculateFPS() {
        if (!fpsElement) return;
        frameCount++;
        const now = performance.now();
        const deltaTime = now - lastUpdateTime;

        if (deltaTime >= 1000) {
          const fps = frameCount;
          fpsElement.textContent = `FPS: ${fps}`;
          frameCount = 0;
          lastUpdateTime = now;
        }
        requestAnimationFrame(calculateFPS);
      }
      document.addEventListener('astro:after-swap', updateTime);
      document.addEventListener('astro:after-swap', updateBattery);
      document.addEventListener('astro:after-swap', calculateFPS);

      updateTime();
      updateBattery();
      requestAnimationFrame(calculateFPS);

      setInterval(updateTime, 60000);
      setInterval(updateBattery, 30000);
    });
  </script>

  <script src="/storage/js/settings.js" is:inline></script>
</AppLayout>
